# 卡尔曼滤波

### 卡尔曼滤波 KF

卡尔曼滤波是一种高效率的递归滤波器，用于从包含噪声的测量中估计动态系统的状态。卡尔曼滤波器中系统的白噪声和测量噪声并不是需要滤除的对象，它们的统计特性是估计过程中需要利用的信息。由于其递归的特性，其算法非常适用于计算机处理。

##### 无控制的、离散型卡尔曼滤波器

- 状态方程：$x_k = A_{k, k-1} x_{k-1} + w_{k-1}$
- 测量方程：$z_k = C_k x_k + v_k$

其中 $w, v$ 分别为过程噪声和测量噪声，满足如下条件：
$$
p(w) \sim N(0, Q), \quad p(v) \sim N(0, R)
$$
其中 $Q, R$ 分别为过程噪声和测量噪声的协方差矩阵。

卡尔曼滤波器可以分为五个步骤，如下所示：

1. $\hat x_k =A_{k,k-1} x_{k-1}$，根据 $k-1$ 时刻的状态预测 $k$ 时刻的状态，由于误差的存在，这个估计不是最优估计。
2. $\hat P_k = A_{k, k-1}  P_{k-1} A_{k, k-1}^T + Q_{k-1}$，状态估计的均方误差，包含两部分：上一时刻状态的最优估计值的均方误差 $P_{k-1}$，由公式5计算；公式1估计的不确定性 $Q_{k-1}$，由过程噪声决定。状态估计的均方误差为二者的平方和。
3. $H_k = \hat P_{k} C_{k}^T [C_k \hat P_k C_k^T + R_k]^{-1}$，滤波增益权重，状态估计的均方误差在整个估计过程（状态估计和测量）的均方误差中所占的比重，用来确定应该对估计值还是测量值更信任。
4. $x_k = \hat x_k + H_k [z_k - C_k \hat x_k]$，当前时刻状态的最优估计值。
5. $P_k = [I - H_k C_k] \hat P_k$，当前时刻状态的最优估计值的均方误差。

卡尔曼滤波器使用过程中的初始值，可以取 $P_0 = Cov(x_0)$。

##### 带控制的、离散型卡尔曼滤波

- 状态方程：$x_k = A_{k, k-1} x_{k-1} + B_{k-1} u_{k-1} + w_{k-1}$
- 测量方程：$z_k = C_k x_k + v_k$

与上述无控制的状态方程相比，增加了控制量 $u_{k-1}$。此时卡尔曼滤波器的步骤相同，公式略有差别：

1. $\hat x_k =A_{k,k-1} x_{k-1} + B_{k-1} u_{k-1}$
2. $\hat P_k = A_{k, k-1}  P_{k-1} A_{k, k-1}^T + Q_{k-1}$
3. $H_k = \hat P_{k} C_{k}^T [C_k \hat P_k C_k^T + R_k]^{-1}$
4. $x_k = \hat x_k + H_k [z_k - C_k \hat x_k]$
5. $P_k = [I - H_k C_k] \hat P_k$

对于连续型的系统，比如动力学系统的估计，需要进行离散化处理。

### 扩展卡尔曼滤波 EKF

由卡尔曼滤波的过程可以看出，其只适用于线性系统。对于非线性系统，可以将其转换成线性系统，或者使用扩展卡尔曼滤波器。

非线性系统的状态方程和测量方程与上述不同，如下所示：

- 状态方程：$x_k = f(x_{k-1}, u_{k-1}, w_{k-1})$
- 测量方程：$z_k = h(x_k, v_k)$

同样的，过程噪声和测量噪声符合：
$$
p(w) \sim N(0, Q), \quad p(v) \sim N(0, R)
$$
忽略误差的影响，对 $x_k, z_k$ 进行估计，为 
$$
\tilde x_k = f(\hat x_{k-1}, u_{k-1}, 0), \quad \tilde z_k = h(\tilde x_k, 0)
$$
将 $f, h$ 在 $x_k = \dot x_k$ 处展开成泰勒级数，只保留到一阶项，得到线性方程:
$$
x_k \approx \tilde x_k + A(x_{k-1} - \hat x_{k-1}) + Ww_{k-1} \\
z_k \approx \tilde z_k + Ck(x_k - \tilde x_k) + Vv_k
$$
其中 $A, W$ 为函数 $f$ 对 $x, w$ 的偏微分而构成的雅可比矩阵，$C, V$ 为函数 $h$ 对 $x, v$ 的偏微分而构成的雅可比矩阵。
$$
A_{[i, j]} = \frac {\part f_{[i]}}{\part x_{[j]}}(\hat x_{k-1}, u_{k-1}, 0) \\
W_{[i, j]} = \frac {\part f_{[i]}}{\part w_{[j]}}(\hat x_{k-1}, u_{k-1}, 0) \\
C_{[i, j]} = \frac {\part h_{[i]}}{\part x_{[j]}}(\tilde x_k, 0) \\
V_{[i, j]} = \frac {\part h_{[i]}}{\part v_{[j]}}(\tilde x_k, 0)
$$
根据线性方程，使用卡尔曼滤波即可。扩展卡尔曼滤波的5个步骤如下：

1. $\hat x_k = f(x_{k-1}, u_{k-1}, 0)$
2. $\hat P_k = A_k P_{k-1} A_k^T + W_K Q_{k-1} W_k^T$
3. $H_k = \hat P_k C_k^T[C_k \hat P_k C_k^T + V_k R_k V_k^T]^{-1}$
4. $x_k = \hat x_k + H_k (z_k - h(\hat x_k, 0))$
5. $P_k = [I-H_k C_k]\hat P_k$



### 无迹卡尔曼滤波 UKF

扩展卡尔曼滤波省略二阶及高阶项的做法，容易导致较大的误差，无迹卡尔曼滤波采用无迹变换，即使用确定性的采样方法近似高斯分布。

记 $X_{k} = [x_{k}^T, u_{k}^T, w_{k}^T]$，则状态方程可以写为：$x_{k+1} = f(X_{k})$，其中 $X_{k}$ 的维度为 $L$，无迹变换的描述如下：
$$
\mathcal X_{k,0} = X_k \\
\mathcal X_{k,i} = X_k + (\sqrt {(L+\lambda)P_k})_i, \quad i \in [1, L] \\
\mathcal X_{k,i} = X_k - (\sqrt {(L+\lambda)P_k})_{i-L}, \quad i \in [L+1, 2L] \\
W_0^{(m)} = \lambda / (L + \lambda) \\
W_0^{(c)} = \lambda / (L + \lambda) + (1 - \alpha^2 + \beta) \\
W_i^{(m)} = W_i^{(c)} = 1 / (2(L+\lambda)), \quad i \in [1, 2L] \\
\lambda = \alpha^2 [L + \kappa] - L
$$
其中 $(*)_i$ 指矩阵的第 $i$ 行，参数 $\alpha$ 用来确定采样点相对于中心点的分布，实际使用时可以设置为一个较小的值，如 $1e-3$；$\beta$ 由状态变量的分布决定的，如高斯分布时会设置值为 2，$\kappa$ 是描述采样点范围的第二个参数，一般设置为0即可。

此时通过非线性方程 $\mathcal Y_{k+1,i} = f(\mathcal X_{k,i})$ 生成一个新的向量 $\mathcal Y_{k+1, i}$ 与状态方程中的 $x_{k+1}$ 有如下关系：
$$
x_{k+1} \approx \displaystyle \sum_{i=0}^{2L} W_i^{(m)} \mathcal Y_{k+1, i} \\
P_{k+1} \approx \displaystyle \sum_{i=0}^{2L} w_i^{(c)} (\mathcal Y_{k+1,i} - x_{k+1})(\mathcal Y_{k+1,i} - x_{k+1})^T
$$
可以看到此时建立一个关于 $x_k$ 的线性方程，就可以使用卡尔曼滤波进行处理了。



### 粒子滤波

除了卡尔曼滤波的扩展方法以外，粒子估计是解决非线性问题的另一种方法，其基本思想是用一组样本来近似表示系统的后验概率分布，然后估计非线性系统的状态。

粒子滤波是求解贝叶斯估计的一种实用算法，贝叶斯最优估计理论包含预测和更新两个步骤：

- 预测：$p(x_k\mid z_{1:k-1}) = \int p(x_k \mid x_{k-1}) p(x_{k-1} \mid z_{1:k-1}) dx_{k-1}$，其中 $p(x_k \mid z_{1:k-1})$ 称为先验概率， $p(x_k \mid x_{k-1})$ 称为状态转移概率，$p(x_{k-1} \mid z_{1:k-1})$ 称为后验概率。
- 更新：$p(x_k \mid z_{1:k}) = \cfrac {p(z_k \mid x_k) p(x_k \mid z_{1:k-1})}{p(z_k \mid z_{1:k-1})}$，其中 $p(z_k \mid z_{1:k-1}) = \int p(z_k \mid x_k) p(x_k \mid z_{1:k-1}) dx_k$ 。

后验概率使用有限个样本估算，$\hat p(x_{k-1} \mid z_{1:k-1}) = \frac 1N \sum_{i=1}^N \delta(x_{k-1} - x_{k-1}^{(i)})$。可以使用 $k$ 替代公式中的 $k-1$，后验概率密度函数为：$p(x_k \mid z_{1:k}) \approx \hat p(x_k \mid z_{1:k}) = \frac 1N \sum_{i=1}^N \delta (x_k - x_k^{(i)}) $。实际使用中后验概率密度函数的形式往往无法得知，通常使用重要性采样获取样本点。

利用一个已知的分布进行采样，记 $x \sim q(x_{0:k} \mid z_{1:k})$，其中 $q$ 为重要性函数，为得到一种递归的计算方法，将重要性函数分解成如下形式：
$$
q(x_{0:k} \mid z_{1:k}) = q(x_k \mid x_{0:k-1}, z_{1:k}) q(x_{0:k-1} \mid z_{1:k-1})
$$
为简化计算，假设 $q$ 满足一阶马尔可夫性，即 $q(x_k \mid x_{0:k-1}, z_{1:k-1}) = q(x_k \mid x_{k-1}, z_{k-1})$，则后验概率改为：$p(x_k \mid z_{1:k}) \approx \hat p(x_k \mid z_{1:k}) = \sum_{i=1}^N \omega_k^{(i)} \delta (x_k - x_k^{(i)}) $，其中 $\omega$ 为权重。重要性函数的选择，可以参考文献 (王法胜, 2014)。

以上通过重要性函数进行采样的方法右称为序贯重要性采样 SIS，具体的步骤如下：

1. 在分布 $q(x_k \mid x_{k-1}, z_k)$ 中随机抽取 $n$ 个有限样本；
2. 计算权重：$\omega_{k}^{(i)} = \omega_{k-1}^{(i)} \cfrac {p(z_k \mid x_k^{(i)}) p(x_k^{(i)} \mid x_{k-1}^{(i)})} {q(x_k^{(i)} \mid x_{k-1}^{(i)}, z_k)}$；
3. 归一化权重：$\omega_{k}^{(i)} = \omega_{k}^{(i)} /\sum_{j=1}^n \omega_{k}^{(j)}$；
4. 估计后验概率：$p(x_k \mid z_{1:k}) \approx \hat p(x_k \mid z_{1:k}) = \sum_{i=1}^N \omega_k^{(i)} \delta (x_k - x_k^{(i)}) $；

仅使用 SIS 会有粒子权值的退化问题，具体表现为经过几次迭代后，多数粒子的权重都变得很小，少数粒子的权重较大，此时估计的性能会下降很多。通常使用有效粒子数来衡量粒子权重的退化：$N_{eff} = N / (1+Var(\omega_k^{(i)}))$。当有效粒子数低于阈值，就必须采取措施，如增加粒子数。实际一般有两种方式：

1. 选择合适的重要性函数；
2. 采用重采样方法。

重采样方法的核心思想是淘汰权重小的粒子，保留并克隆权重大的粒子，将所有粒子的权重设置为 $1/N$。重采样的具体方法有多种，如假设有3个粒子，在 $k$ 时刻的权重为 [0.1, 0.1, 0.8]，计算它们的概率累积为 [0.1, 0.2, 1.0]，使用 0-1 均匀分布对累积进行随机采样，采样3个值，假设为 [0.15, 0.38, 0.54]，则淘汰第一个粒子，第二个粒子保留，第三个粒子保留并复制一次。



##### 参考文献

*Bishop G, Welch G. An introduction to the kalman filter[J]. Proc of SIGGRAPH, Course, 2001, 8(27599-23175): 41.*

*Wan E A, Van Der Merwe R. The unscented Kalman filter for nonlinear estimation[C]//Proceedings of the IEEE 2000 Adaptive Systems for Signal Processing, Communications, and Control Symposium (Cat. No. 00EX373). Ieee, 2000: 153-158.*

*王法胜, 鲁明羽, 赵清杰, et al. 粒子滤波算法[J]. 计算机学报, 2014, 37(8):1679-1694.*

*胡士强, 敬忠良. 粒子滤波算法综述[J]. 控制与决策, 2005, 20(4).*